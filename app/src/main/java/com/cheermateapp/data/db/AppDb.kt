package com.cheermateapp.data.db

import android.content.Context
import android.util.Log
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase
import androidx.room.TypeConverters
import androidx.room.migration.Migration
import androidx.sqlite.db.SupportSQLiteDatabase
import com.cheermateapp.data.dao.MessageTemplateDao
import com.cheermateapp.data.dao.PersonalityDao
import com.cheermateapp.data.dao.SecurityDao
import com.cheermateapp.data.dao.UserSettingsDao
import com.cheermateapp.data.dao.SubTaskDao
import com.cheermateapp.data.dao.TaskDao
import com.cheermateapp.data.dao.TaskDependencyDao
import com.cheermateapp.data.dao.TaskReminderDao
import com.cheermateapp.data.dao.UserDao
import com.cheermateapp.data.model.MessageTemplate
import com.cheermateapp.data.model.Personality
import com.cheermateapp.data.model.SecurityQuestion
import com.cheermateapp.data.model.UserSecurityAnswer
import com.cheermateapp.data.model.UserSettings
import com.cheermateapp.data.model.SubTask
import com.cheermateapp.data.model.Task
import com.cheermateapp.data.model.TaskDependency
import com.cheermateapp.data.model.TaskReminder
import com.cheermateapp.data.model.User
import com.google.gson.Gson
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

@Database(

    entities = [

        Personality::class,

        User::class,

        Task::class,

        TaskReminder::class,

        SubTask::class,

        SecurityQuestion::class,

        UserSecurityAnswer::class,

        UserSettings::class,

        MessageTemplate::class,

                TaskDependency::class

        

            ],

        

                        version = 30,

        

            

        

                    

        

            

        

                        exportSchema = false

        

            

        

                    

        

            

        

                    )

        

            

        

                    

        

            

        

                    @TypeConverters(AppTypeConverters::class)

        

            

        

                    

        

            

        

                    abstract class AppDb : RoomDatabase() {

        

            

        

                    

        

            

        

                        abstract fun userDao(): UserDao

        

            

        

                    

        

            

        

                        abstract fun taskDao(): TaskDao

        

            

        

                    

        

            

        

                        abstract fun subTaskDao(): SubTaskDao

        

            

        

                    

        

            

        

                        abstract fun taskReminderDao(): TaskReminderDao

        

            

        

                    

        

            

        

                        abstract fun userSettingsDao(): UserSettingsDao

        

            

        

                    

        

            

        

                        abstract fun securityDao(): SecurityDao

        

            

        

                    

        

            

        

                        abstract fun personalityDao(): PersonalityDao

        

            

        

                    

        

            

        

                        abstract fun messageTemplateDao(): MessageTemplateDao

        

            

        

                    

        

            

        

                        abstract fun taskDependencyDao(): TaskDependencyDao

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                        companion object {

        

            

        

                    

        

            

        

                            private const val TAG = "AppDb"

        

            

        

                    

        

            

        

                            

        

            

        

                            @Volatile

        

            

        

                    

        

            

        

                            private var INSTANCE: AppDb? = null

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            fun get(context: Context): AppDb {

        

            

        

                    

        

            

        

                                return INSTANCE ?: synchronized(this) {

        

            

        

                    

        

            

        

                                    INSTANCE ?: buildDatabase(context.applicationContext).also { INSTANCE = it }

        

            

        

                    

        

            

        

                                }

        

            

        

                    

        

            

        

                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            private val MIGRATION_19_20 = object : Migration(19, 20) {

        

            

        

                    

        

            

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                    

        

            

        

                                    // Create new table with NOT NULL constraints

        

            

        

                    

        

            

        

                                    database.execSQL("""

        

            

        

                    

        

            

        

                                        CREATE TABLE User_new (

        

            

        

                    

        

            

        

                                            User_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

            

        

                    

        

            

        

                                            Username TEXT NOT NULL,

        

            

        

                    

        

            

        

                                            Email TEXT NOT NULL,

        

            

        

                    

        

            

        

                                            PasswordHash TEXT NOT NULL,

        

            

        

                    

        

            

        

                                            FirstName TEXT NOT NULL DEFAULT '',

        

            

        

                    

        

            

        

                                            LastName TEXT NOT NULL DEFAULT '',

        

            

        

                    

        

            

        

                                            Birthdate TEXT,

        

            

        

                    

        

            

        

                                            Personality_ID INTEGER,

        

            

        

                    

        

            

        

                                            CreatedAt INTEGER NOT NULL,

        

            

        

                    

        

            

        

                                            UpdatedAt INTEGER NOT NULL,

        

            

        

                    

        

            

        

                                            DeletedAt INTEGER

        

            

        

                    

        

            

        

                                        )

        

            

        

                    

        

            

        

                                    """)

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                    // Copy data from old table to new table, coalescing null names to empty strings

        

            

        

                    

        

            

        

                                    database.execSQL("""

        

            

        

                    

        

            

        

                                        INSERT INTO User_new (User_ID, Username, Email, PasswordHash, FirstName, LastName, Birthdate, Personality_ID, CreatedAt, UpdatedAt, DeletedAt)

        

            

        

                    

        

            

        

                                        SELECT User_ID, Username, Email, PasswordHash, COALESCE(FirstName, ''), COALESCE(LastName, ''), Birthdate, Personality_ID, CreatedAt, UpdatedAt, DeletedAt FROM User

        

            

        

                    

        

            

        

                                    """)

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                    // Drop old table

        

            

        

                    

        

            

        

                                    database.execSQL("DROP TABLE User")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                    // Rename new table to old table name

        

            

        

                    

        

            

        

                                    database.execSQL("ALTER TABLE User_new RENAME TO User")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                    // Re-create indexes from original schema

        

            

        

                    

        

            

        

                                    database.execSQL("CREATE UNIQUE INDEX IF NOT EXISTS index_User_Username ON User(Username)")

        

            

        

                    

        

            

        

                                    database.execSQL("CREATE UNIQUE INDEX IF NOT EXISTS index_User_Email ON User(Email)")

        

            

        

                    

        

            

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_User_Personality_ID ON User(Personality_ID)")

        

            

        

                    

        

            

        

                                }

        

            

        

                    

        

            

        

                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            private val MIGRATION_20_21 = object : Migration(20, 21) {

        

            

        

                    

        

            

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                    

        

            

        

                                    // Drop RecurringTask table and its indexes

        

            

        

                    

        

            

        

                                    database.execSQL("DROP TABLE IF EXISTS RecurringTask")

        

            

        

                    

        

            

        

                                    

        

            

        

                                    // Drop TaskTemplate table and its indexes

        

            

        

                    

        

            

        

                                    database.execSQL("DROP TABLE IF EXISTS TaskTemplate")

        

            

        

                    

        

            

        

                                }

        

            

        

                    

        

            

        

                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            private val MIGRATION_21_22 = object : Migration(21, 22) {

        

            

        

                    

        

            

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                    

        

            

        

                                    // Create new UserSettings table with updated schema

        

            

        

                    

        

            

        

                                    database.execSQL("""

        

            

        

                    

        

            

        

                                        CREATE TABLE IF NOT EXISTS UserSettings (

        

            

        

                    

        

            

        

                                            UserSettings_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

            

        

                    

        

            

        

                                            User_ID INTEGER NOT NULL,

        

            

        

                    

        

            

        

                                            Appearance TEXT,

        

            

        

                    

        

            

        

                                            Notification TEXT,

        

            

        

                    

        

            

        

                                            DataManagement TEXT,

        

            

        

                    

        

            

        

                                            Statistics TEXT,

        

            

        

                    

        

            

        

                                            FOREIGN KEY (User_ID) REFERENCES User(User_ID) ON DELETE CASCADE

        

            

        

                    

        

            

        

                                        )

        

            

        

                    

        

            

        

                                    """)

        

            

        

                    

        

            

        

                                    

        

            

        

                                    // Create index on User_ID

        

            

        

                    

        

            

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSettings_User_ID ON UserSettings(User_ID)")

        

            

        

                    

        

            

        

                                    

        

            

        

                                    // Migrate data from old Settings table (if exists) to new UserSettings table

        

            

        

                    

        

            

        

                                    database.execSQL("""

        

            

        

                    

        

            

        

                                        INSERT INTO UserSettings (User_ID, Appearance, Notification, DataManagement, Statistics)

        

            

        

                    

        

            

        

                                        SELECT User_ID, Appearance, Notification, DataManagement, Statistics FROM Settings

        

            

        

                    

        

            

        

                                    """)

        

            

        

                    

        

            

        

                                    

        

            

        

                                    // Drop old Settings table

        

            

        

                    

        

            

        

                                    database.execSQL("DROP TABLE IF EXISTS Settings")

        

            

        

                    

        

            

        

                                }

        

            

        

                    

        

            

        

                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            private val MIGRATION_22_23 = object : Migration(22, 23) {

        

            

        

                    

        

            

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                    

        

            

        

                                    database.execSQL("ALTER TABLE MessageTemplate RENAME COLUMN TextTemplate TO MessageText")

        

            

        

                    

        

            

        

                                }

        

            

        

                    

        

            

        

                            }

        

            

        

                    

        

            

        

                            private val MIGRATION_23_24 = object : Migration(23, 24) {

        

            

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                                    // Create a new table with the desired schema

        

            

        

                                    database.execSQL("""

        

            

        

                                        CREATE TABLE Personality_new (

        

            

        

                                            Personality_ID INTEGER NOT NULL PRIMARY KEY,

        

            

        

                                            Name TEXT NOT NULL,

        

            

        

                                            Description TEXT NOT NULL

        

            

        

                                        )

        

            

        

                                    """)

        

            

        

                    

        

            

        

                                    // Copy the data from the old table to the new table

        

            

        

                                    database.execSQL("""

        

            

        

                                        INSERT INTO Personality_new (Personality_ID, Name, Description)

        

            

        

                                        SELECT Personality_ID, Name, Description FROM Personality

        

            

        

                                    """)

        

            

        

                    

        

            

        

                                    // Drop the old table

        

            

        

                                    database.execSQL("DROP TABLE Personality")

        

            

        

                    

        

            

        

                                    // Rename the new table to the original table name

        

            

        

                                    database.execSQL("ALTER TABLE Personality_new RENAME TO Personality")

        

            

        

                                }

        

            

        

                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                            private val MIGRATION_24_25 = object : Migration(24, 25) {

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    // Create new table without the Birthdate column

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("""

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                        CREATE TABLE User_new (

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            User_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            Username TEXT NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            Email TEXT NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            PasswordHash TEXT NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            FirstName TEXT NOT NULL DEFAULT '',

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            LastName TEXT NOT NULL DEFAULT '',

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            Personality_ID INTEGER,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            CreatedAt INTEGER NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            UpdatedAt INTEGER NOT NULL,

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                            DeletedAt INTEGER

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                        )

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    """)

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    // Copy data from old table to new table

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("""

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                        INSERT INTO User_new (User_ID, Username, Email, PasswordHash, FirstName, LastName, Personality_ID, CreatedAt, UpdatedAt, DeletedAt)

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                        SELECT User_ID, Username, Email, PasswordHash, FirstName, LastName, Personality_ID, CreatedAt, UpdatedAt, DeletedAt FROM User

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    """)

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    // Drop old table

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("DROP TABLE User")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    // Rename new table to old table name

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("ALTER TABLE User_new RENAME TO User")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    // Re-create indexes

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("CREATE UNIQUE INDEX IF NOT EXISTS index_User_Username ON User(Username)")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("CREATE UNIQUE INDEX IF NOT EXISTS index_User_Email ON User(Email)")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_User_Personality_ID ON User(Personality_ID)")

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                                }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                                            }

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                    

        

            

        

                            private val MIGRATION_25_26 = object : Migration(25, 26) {

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

                                    // Create new table without the DataManagement and Statistics columns

        

                                    database.execSQL("""

        

                                        CREATE TABLE UserSettings_new (

        

                                            UserSettings_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

                                            User_ID INTEGER NOT NULL,

        

                                            Appearance TEXT,

        

                                            Notification TEXT,

        

                                            FOREIGN KEY (User_ID) REFERENCES User(User_ID) ON DELETE CASCADE

        

                                        )

        

                                    """)

        

            

        

                                    // Copy data from old table to new table

        

                                    database.execSQL("""

        

                                        INSERT INTO UserSettings_new (UserSettings_ID, User_ID, Appearance, Notification)

        

                                        SELECT UserSettings_ID, User_ID, Appearance, Notification FROM UserSettings

        

                                    """)

        

            

        

                                    // Drop old table

        

                                    database.execSQL("DROP TABLE UserSettings")

        

            

        

                                    // Rename new table to old table name

        

                                    database.execSQL("ALTER TABLE UserSettings_new RENAME TO UserSettings")

        

            

        

                                    // Re-create index

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSettings_User_ID ON UserSettings(User_ID)")

        

                                }

        

                            }

        

            

        

            

        

            

        

            

        

            

        

                            private val MIGRATION_26_27 = object : Migration(26, 27) {

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

                                    // Create new table without the SortOrder, UpdatedAt, and DeletedAt columns

        

                                    database.execSQL("""

        

                                        CREATE TABLE SubTask_new (

        

                                            SubTask_ID INTEGER NOT NULL,

        

                                            Task_ID INTEGER NOT NULL,

        

                                            User_ID INTEGER NOT NULL,

        

                                            Name TEXT NOT NULL,

        

                                            IsCompleted INTEGER NOT NULL,

        

                                            CreatedAt INTEGER NOT NULL,

        

                                            PRIMARY KEY(Task_ID, User_ID, SubTask_ID),

        

                                            FOREIGN KEY(Task_ID, User_ID) REFERENCES Task(Task_ID, User_ID) ON DELETE CASCADE

        

                                        )

        

                                    """)

        

            

        

                                    // Copy data from old table to new table

        

                                    database.execSQL("""

        

                                        INSERT INTO SubTask_new (SubTask_ID, Task_ID, User_ID, Name, IsCompleted, CreatedAt)

        

                                        SELECT SubTask_ID, Task_ID, User_ID, Name, IsCompleted, CreatedAt FROM SubTask

        

                                    """)

        

            

        

                                    // Drop old table

        

                                    database.execSQL("DROP TABLE SubTask")

        

            

        

                                    // Rename new table to old table name

        

                                    database.execSQL("ALTER TABLE SubTask_new RENAME TO SubTask")

        

            

        

                                    // Re-create indexes

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_SubTask_Task_ID ON SubTask(Task_ID)")

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_SubTask_User_ID ON SubTask(User_ID)")

        

                                }

        

                            }

        

            

        

            

        

            

        

            

        

            

        

                            private val MIGRATION_27_28 = object : Migration(27, 28) {

        

                                override fun migrate(database: SupportSQLiteDatabase) {

        

                                    // Re-create SecurityQuestion table

        

                                    database.execSQL("""

        

                                        CREATE TABLE SecurityQuestion_new (

        

                                            Question_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

                                            Prompt TEXT NOT NULL

        

                                        )

        

                                    """)

        

                                    database.execSQL("""

        

                                        INSERT INTO SecurityQuestion_new (Question_ID, Prompt)

        

                                        SELECT SecurityQuestion_ID, Prompt FROM SecurityQuestion

        

                                    """)

        

                                    database.execSQL("DROP TABLE SecurityQuestion")

        

                                    database.execSQL("ALTER TABLE SecurityQuestion_new RENAME TO SecurityQuestion")

        

                                    

        

                                    // Re-create UserSecurityAnswer table with the correct foreign key

        

                                    database.execSQL("""

        

                                        CREATE TABLE UserSecurityAnswer_new (

        

                                            Answer_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

                                            User_ID INTEGER NOT NULL,

        

                                            Question_ID INTEGER NOT NULL,

        

                                            AnswerHash TEXT NOT NULL,

        

                                            FOREIGN KEY(Question_ID) REFERENCES SecurityQuestion(Question_ID) ON DELETE CASCADE

        

                                        )

        

                                    """)

        

                                    database.execSQL("""

        

                                        INSERT INTO UserSecurityAnswer_new (Answer_ID, User_ID, Question_ID, AnswerHash)

        

                                        SELECT Answer_ID, User_ID, Question_ID, AnswerHash FROM UserSecurityAnswer

        

                                    """)

        

                                    database.execSQL("DROP TABLE UserSecurityAnswer")

        

                                    database.execSQL("ALTER TABLE UserSecurityAnswer_new RENAME TO UserSecurityAnswer")

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSecurityAnswer_User_ID ON UserSecurityAnswer(User_ID)")

        

                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSecurityAnswer_Question_ID ON UserSecurityAnswer(Question_ID)")

        

                                }

        

                            }

        

            

        

            

        

            

        

            

        

            

        

                                                            private val MIGRATION_29_30 = object : Migration(29, 30) {

        

            

        

            

        

            

        

            

        

            

        

                                                                override fun migrate(database: SupportSQLiteDatabase) {

        

            

        

            

        

            

        

            

        

            

        

                                                                    // Re-create SecurityQuestion table

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("""

        

            

        

            

        

            

        

            

        

            

        

                                                                        CREATE TABLE SecurityQuestion_new (

        

            

        

            

        

            

        

            

        

            

        

                                                                            Question_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

            

        

            

        

            

        

            

        

            

        

                                                                            Prompt TEXT NOT NULL

        

            

        

            

        

            

        

            

        

            

        

                                                                        )

        

            

        

            

        

            

        

            

        

            

        

                                                                    """)

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("""

        

            

        

            

        

            

        

            

        

            

        

                                                                        INSERT INTO SecurityQuestion_new (Question_ID, Prompt)

        

            

        

            

        

            

        

            

        

            

        

                                                                        SELECT SecurityQuestion_ID, Prompt FROM SecurityQuestion

        

            

        

            

        

            

        

            

        

            

        

                                                                    """)

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("DROP TABLE SecurityQuestion")

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("ALTER TABLE SecurityQuestion_new RENAME TO SecurityQuestion")

        

            

        

            

        

            

        

            

        

            

        

                                                                    

        

            

        

            

        

            

        

            

        

            

        

                                                                    // Re-create UserSecurityAnswer table with the correct foreign key

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("""

        

            

        

            

        

            

        

            

        

            

        

                                                                        CREATE TABLE UserSecurityAnswer_new (

        

            

        

            

        

            

        

            

        

            

        

                                                                            Answer_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,

        

            

        

            

        

            

        

            

        

            

        

                                                                            User_ID INTEGER NOT NULL,

        

            

        

            

        

            

        

            

        

            

        

                                                                            Question_ID INTEGER NOT NULL,

        

            

        

            

        

            

        

            

        

            

        

                                                                            AnswerHash TEXT NOT NULL,

        

            

        

            

        

            

        

            

        

            

        

                                                                            FOREIGN KEY(Question_ID) REFERENCES SecurityQuestion(Question_ID) ON DELETE CASCADE

        

            

        

            

        

            

        

            

        

            

        

                                                                        )

        

            

        

            

        

            

        

            

        

            

        

                                                                    """)

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("""

        

            

        

            

        

            

        

            

        

            

        

                                                                        INSERT INTO UserSecurityAnswer_new (Answer_ID, User_ID, Question_ID, AnswerHash)

        

            

        

            

        

            

        

            

        

            

        

                                                                        SELECT Answer_ID, User_ID, Question_ID, AnswerHash FROM UserSecurityAnswer

        

            

        

            

        

            

        

            

        

            

        

                                                                    """)

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("DROP TABLE UserSecurityAnswer")

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("ALTER TABLE UserSecurityAnswer_new RENAME TO UserSecurityAnswer")

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSecurityAnswer_User_ID ON UserSecurityAnswer(User_ID)")

        

            

        

            

        

            

        

            

        

            

        

                                                                    database.execSQL("CREATE INDEX IF NOT EXISTS index_UserSecurityAnswer_Question_ID ON UserSecurityAnswer(Question_ID)")

        

            

        

            

        

            

        

            

        

            

        

                                                                }

        

            

        

            

        

            

        

            

        

            

        

                                                            }

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                            private fun buildDatabase(appContext: Context): AppDb {

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                val gson = Gson()

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                return Room.databaseBuilder(

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    appContext,

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    AppDb::class.java,

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    "cheermate_database"

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                )

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    .addTypeConverter(AppTypeConverters(gson))

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    .addMigrations(MIGRATION_19_20, MIGRATION_20_21, MIGRATION_21_22, MIGRATION_22_23, MIGRATION_23_24, MIGRATION_24_25, MIGRATION_25_26, MIGRATION_26_27, MIGRATION_27_28, MIGRATION_29_30)

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                                    .build()

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                            

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                    

        

            

        

            

        

            

        

            

        

            

        

                                            

        

            

        

            

        

            

        

            

        

            

        

                                                                            }

        

            

        

                    

        

            

        

                        }

        

            

        

                    

        

            

        

                    }
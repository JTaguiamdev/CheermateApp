name: ğŸš€ Build Test APK

# Trigger on push to main branch or manual trigger
on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'screenshots/**'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - beta
        - release
      custom_message:
        description: 'Custom release message'
        required: false
        default: 'Test release for testers'

jobs:
  build-apk:
    name: ğŸ“± Build & Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ“¦ Cache Gradle Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: ğŸ”§ Make Gradlew Executable
      run: chmod +x ./gradlew
    
    - name: ğŸ§¹ Clean Build
      run: ./gradlew clean
    
    - name: ğŸ”¨ Build Debug APK
      run: ./gradlew assembleDebug
    
    - name: ğŸ“Š Generate Build Info
      id: build_info
      run: |
        echo "build_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "version=v1.5-test-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        
        # Find APK file (try multiple naming patterns)
        APK_FILE=""
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_FILE="app/build/outputs/apk/debug/app-debug.apk"
        elif [ -f "app/build/outputs/apk/debug/CheermateApp-1.0-debug.apk" ]; then
          APK_FILE="app/build/outputs/apk/debug/CheermateApp-1.0-debug.apk"
        else
          echo "APK not found! Contents of debug directory:"
          ls -la app/build/outputs/apk/debug/
          exit 1
        fi
        
        # Calculate APK size
        APK_SIZE=$(stat -c%s "$APK_FILE")
        APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
        echo "apk_size=${APK_SIZE_MB}MB" >> $GITHUB_OUTPUT
        echo "apk_file=${APK_FILE}" >> $GITHUB_OUTPUT
    
    - name: ğŸ“ Generate Release Notes
      id: release_notes
      run: |
        cat << 'EOF' > release_notes.md
        # ğŸš€ CheermateApp Test Release ${{ steps.build_info.outputs.version }}
        
        ## ğŸ“± Quick Install
        
        1. **Download APK** from Assets below
        2. **Enable Unknown Sources** in Android Settings > Security
        3. **Install APK** by tapping the downloaded file
        4. **Grant permissions** when prompted
        
        ## âœ¨ New Features to Test
        
        ### ğŸ‘† Swipe Gestures (NEW!)
        - **Swipe Right** â†’ Mark task as completed âœ…
        - **Swipe Left** â†’ Delete task ğŸ—‘ï¸ 
        - **Confirmation dialogs** prevent accidents
        - **Visual feedback** with green/red backgrounds
        
        ### ğŸ¨ Enhanced UI
        - **Dark Mode Toggle** in Settings ğŸŒ™
        - **Live Statistics** updates in Settings ğŸ“Š
        - **Smooth Animations** throughout the app
        
        ### ğŸ“‹ Core Features
        - **Task Management**: Create, edit, complete tasks
        - **Smart Filtering**: All | Today | Pending | Done
        - **Real-time Search**: Find tasks instantly ğŸ”
        - **Progress Tracking**: Visual completion indicators
        
        ## ğŸ§ª Testing Priority
        
        **Please focus on testing:**
        
        - [ ] ğŸ‘† **Swipe gestures** (NEW feature!)
        - [ ] ğŸŒ™ **Dark mode** toggle
        - [ ] ğŸ“Š **Statistics** live updates
        - [ ] ğŸ“± **General app stability**
        
        ## ğŸ› Report Issues
        
        **Found a bug?** Please report with:
        - **Steps to reproduce**
        - **Expected vs actual behavior** 
        - **Device model & Android version**
        - **Screenshots** (if helpful)
        
        ## ğŸ“‹ Build Details
        
        - **Build Date**: ${{ steps.build_info.outputs.build_date }}
        - **Version**: 1.5 (Enhanced UX & Smart Features)
        - **Commit**: ${{ steps.build_info.outputs.commit_sha }}
        - **APK Size**: ${{ steps.build_info.outputs.apk_size }}
        - **Build Type**: Debug (Testing)
        
        ---
        
        **Thank you for testing!** ğŸ™ Your feedback makes CheermateApp better!
        EOF
    
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CheermateApp-${{ steps.build_info.outputs.version }}
        path: ${{ steps.build_info.outputs.apk_file }}
        retention-days: 30
    
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.build_info.outputs.version }}
        name: ğŸš€ CheermateApp Test - ${{ steps.build_info.outputs.version }}
        body_path: release_notes.md
        files: ${{ steps.build_info.outputs.apk_file }}
        prerelease: true
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± Release Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.build_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Size**: ${{ steps.build_info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: ${{ steps.build_info.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ steps.build_info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- **[ğŸ“¦ View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.build_info.outputs.version }})**" >> $GITHUB_STEP_SUMMARY
        echo "- **[ğŸ“± Download APK](https://github.com/${{ github.repository }}/releases/download/${{ steps.build_info.outputs.version }}/app-debug.apk)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ For Testers" >> $GITHUB_STEP_SUMMARY
        echo "Share the release link with testers: https://github.com/${{ github.repository }}/releases/tag/${{ steps.build_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY